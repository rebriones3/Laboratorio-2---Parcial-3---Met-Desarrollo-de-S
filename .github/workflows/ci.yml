name: CI - Con MongoDB (Definitivo)

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  test-con-mongodb:
    name: Tests Completos con MongoDB
    runs-on: ubuntu-latest
    timeout-minutes: 12
    
    services:
      mongodb:
        image: mongo:5.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.runCommand({ ping: 1 })' || mongo --quiet --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: â³ Verificar MongoDB
      run: |
        echo "Verificando conexiÃ³n a MongoDB..."
        for i in {1..30}; do
          if mongosh --eval "db.adminCommand('ping')" > /dev/null 2>&1 || \
             mongo --eval "db.adminCommand('ping')" > /dev/null 2>&1; then
            echo "âœ… MongoDB estÃ¡ listo!"
            exit 0
          fi
          echo "Esperando MongoDB... intento $i/30"
          sleep 2
        done
        echo "âŒ MongoDB no respondiÃ³ a tiempo"
        exit 1
      timeout-minutes: 2
    
    - name: ğŸ”¨ Compilar Proyecto
      run: mvn clean compile
      timeout-minutes: 2
      
    - name: ğŸ§ª Ejecutar Tests
      run: mvn test
      timeout-minutes: 6
      env:
        MONGODB_HOST: localhost
        MONGODB_PORT: 27017
      continue-on-error: false
      
    - name: ğŸ“Š Generar Reporte JaCoCo
      run: mvn jacoco:report
      timeout-minutes: 2
      if: always()
      
    - name: âœ… Verificar Cobertura
      run: mvn jacoco:check
      continue-on-error: true
      
    - name: ğŸ“¤ Subir Reporte
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: jacoco-report-mongodb
        path: target/site/jacoco/
        retention-days: 30
        
    - name: ğŸ“‹ Resumen
      if: always()
      run: |
        echo "================================================"
        echo "âœ… Pipeline con MongoDB completado"
        echo "ğŸ“Š Reporte JaCoCo disponible"
        echo "ğŸ—„ï¸  Tests con MongoDB real ejecutados"
        echo "ğŸ“¥ Descarga 'jacoco-report-mongodb'"
        echo "================================================"
