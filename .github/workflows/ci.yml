name: CI Pipeline - Optimizado

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    name: Tests & Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 10  # â±ï¸ Timeout de 10 minutos mÃ¡ximo
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
        
    - name: ğŸ§ª Run Tests (Skip MongoDB)
      run: |
        mvn clean test \
          -Dmaven.test.skip=false \
          -DskipTests=false \
          -Dtest='!**/*MongoTest' \
          -Dfailsafe.timeout=300
      timeout-minutes: 5  # â±ï¸ Tests mÃ¡ximo 5 minutos
      
    - name: ğŸ“Š Generate JaCoCo Report
      run: mvn jacoco:report
      timeout-minutes: 2
      
    - name: âœ… Verify Coverage (65%)
      run: mvn jacoco:check
      continue-on-error: false
      
    - name: ğŸ“¤ Upload JaCoCo Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: jacoco-report
        path: target/site/jacoco/
        retention-days: 30
        
    - name: ğŸ“ˆ Summary
      if: always()
      run: |
        echo "âœ… Pipeline completed!"
        echo "ğŸ“Š Report: target/site/jacoco/"
        echo "ğŸ“¥ Download 'jacoco-report' artifact"
